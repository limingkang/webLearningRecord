<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>选型 | 前端学习</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="努力学习">
    <link rel="preload" href="/webLearningRecord/assets/css/0.styles.32aa171d.css" as="style"><link rel="preload" href="/webLearningRecord/assets/js/app.bdc4d5ac.js" as="script"><link rel="preload" href="/webLearningRecord/assets/js/2.1a231426.js" as="script"><link rel="preload" href="/webLearningRecord/assets/js/8.62631f20.js" as="script"><link rel="prefetch" href="/webLearningRecord/assets/js/10.6c45162c.js"><link rel="prefetch" href="/webLearningRecord/assets/js/11.f477fe3a.js"><link rel="prefetch" href="/webLearningRecord/assets/js/12.719839a4.js"><link rel="prefetch" href="/webLearningRecord/assets/js/13.2e776131.js"><link rel="prefetch" href="/webLearningRecord/assets/js/14.6961d267.js"><link rel="prefetch" href="/webLearningRecord/assets/js/15.94790cc9.js"><link rel="prefetch" href="/webLearningRecord/assets/js/16.5c5eee38.js"><link rel="prefetch" href="/webLearningRecord/assets/js/17.025ef091.js"><link rel="prefetch" href="/webLearningRecord/assets/js/18.ef4a8780.js"><link rel="prefetch" href="/webLearningRecord/assets/js/19.ec38cef5.js"><link rel="prefetch" href="/webLearningRecord/assets/js/20.f6711983.js"><link rel="prefetch" href="/webLearningRecord/assets/js/21.0cef24fe.js"><link rel="prefetch" href="/webLearningRecord/assets/js/22.9224a013.js"><link rel="prefetch" href="/webLearningRecord/assets/js/23.ec789df6.js"><link rel="prefetch" href="/webLearningRecord/assets/js/24.3bce65fe.js"><link rel="prefetch" href="/webLearningRecord/assets/js/25.f4d74d85.js"><link rel="prefetch" href="/webLearningRecord/assets/js/26.70ee71fc.js"><link rel="prefetch" href="/webLearningRecord/assets/js/27.39bdc05b.js"><link rel="prefetch" href="/webLearningRecord/assets/js/28.31277bb6.js"><link rel="prefetch" href="/webLearningRecord/assets/js/29.97b7aecc.js"><link rel="prefetch" href="/webLearningRecord/assets/js/3.9f1b9f7a.js"><link rel="prefetch" href="/webLearningRecord/assets/js/30.bcf3c482.js"><link rel="prefetch" href="/webLearningRecord/assets/js/31.e07b317a.js"><link rel="prefetch" href="/webLearningRecord/assets/js/32.1352871c.js"><link rel="prefetch" href="/webLearningRecord/assets/js/33.f98a7f1c.js"><link rel="prefetch" href="/webLearningRecord/assets/js/34.3797f037.js"><link rel="prefetch" href="/webLearningRecord/assets/js/4.217c5e32.js"><link rel="prefetch" href="/webLearningRecord/assets/js/5.bd81a106.js"><link rel="prefetch" href="/webLearningRecord/assets/js/6.d3f0121d.js"><link rel="prefetch" href="/webLearningRecord/assets/js/7.c3e5ebfe.js"><link rel="prefetch" href="/webLearningRecord/assets/js/9.094f8da5.js">
    <link rel="stylesheet" href="/webLearningRecord/assets/css/0.styles.32aa171d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/webLearningRecord/" class="home-link router-link-active"><!----> <span class="site-name">前端学习</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/limingkang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/limingkang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>浏览器工作原理和实践</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/browser-theory/chromeConstruct.html" class="sidebar-link">chrome架构</a></li><li><a href="/webLearningRecord/browser-theory/other.html" class="sidebar-link">缓存和安全</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active open"><span>微前端架构</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/web-consttruct/singleSpa.html" class="sidebar-link">single-spa方式实现</a></li><li><a href="/webLearningRecord/web-consttruct/mySingleSpa.html" class="sidebar-link">自己实现一个微前端</a></li><li><a href="/webLearningRecord/web-consttruct/mircoapp.html" class="active sidebar-link">microapp</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webLearningRecord/web-consttruct/mircoapp.html#选型" class="sidebar-link">选型</a></li><li class="sidebar-sub-header"><a href="/webLearningRecord/web-consttruct/mircoapp.html#渲染篇" class="sidebar-link">渲染篇</a></li><li class="sidebar-sub-header"><a href="/webLearningRecord/web-consttruct/mircoapp.html#沙箱篇" class="sidebar-link">沙箱篇</a></li><li class="sidebar-sub-header"><a href="/webLearningRecord/web-consttruct/mircoapp.html#样式隔离篇" class="sidebar-link">样式隔离篇</a></li><li class="sidebar-sub-header"><a href="/webLearningRecord/web-consttruct/mircoapp.html#数据通信篇" class="sidebar-link">数据通信篇</a></li><li class="sidebar-sub-header"><a href="/webLearningRecord/web-consttruct/mircoapp.html#优化" class="sidebar-link">优化</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>前端性能监控</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/web-observe/web-observe.html" class="sidebar-link">构建前端性能监控</a></li><li><a href="/webLearningRecord/web-observe/user-behavior.html" class="sidebar-link">用户行为录制</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>vue2源码分析</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/vue-analyze/vue2.html" class="sidebar-link">初始化过程</a></li><li><a href="/webLearningRecord/vue-analyze/components.html" class="sidebar-link">组件化</a></li><li><a href="/webLearningRecord/vue-analyze/reactive.html" class="sidebar-link">响应式原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>包管理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/bundle/analysize.html" class="sidebar-link">rollup</a></li><li><a href="/webLearningRecord/bundle/pnpm.html" class="sidebar-link">pnpm</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>vite</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/vite/prelearn.html" class="sidebar-link">基础知识</a></li><li><a href="/webLearningRecord/vite/analysize.html" class="sidebar-link">源码分析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>react浅析</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/react/react.html" class="sidebar-link">react初探</a></li><li><a href="/webLearningRecord/react/two.html" class="sidebar-link">react架构实现</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>经常忘记</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/forget/one.html" class="sidebar-link">JavaScript</a></li><li><a href="/webLearningRecord/forget/two.html" class="sidebar-link">TypeScript</a></li><li><a href="/webLearningRecord/forget/three.html" class="sidebar-link">CSS</a></li><li><a href="/webLearningRecord/forget/four.html" class="sidebar-link">Node</a></li><li><a href="/webLearningRecord/forget/five.html" class="sidebar-link">经常使用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>笔试题</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/algorithm/one.html" class="sidebar-link">算法</a></li><li><a href="/webLearningRecord/algorithm/two.html" class="sidebar-link">手写函数</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/webLearningRecord/" class="sidebar-heading clickable router-link-active"><span>随笔</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/webLearningRecord/think/mess.html" class="sidebar-link">杂谈</a></li><li><a href="/webLearningRecord/think/css.html" class="sidebar-link">css方法论</a></li><li><a href="/webLearningRecord/think/svelte.html" class="sidebar-link">svelte</a></li><li><a href="/webLearningRecord/think/frame.html" class="sidebar-link">框架</a></li><li><a href="/webLearningRecord/think/outer.html" class="sidebar-link">基础文章</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="选型"><a href="#选型" class="header-anchor">#</a> 选型</h2> <p>微前端不是一个库，是一种前端架构的设计思路，要实现微前端，本质上就是在运行时远程加载应用。实现微前端，有几个思路，从构建的角度来看有两种，编译时构建微前端和
运行时构建微前端：</p> <ul><li>编译时微前端，通常将第三方库中的组件作为包，在构建时引入依赖。这种实现引入新的微前端需要重新编译，不够灵活。编译时的微前端可以通过Web Components，Monorepo等
方式来实现。其中Monorepo非常流行，常见的工具有nx，rush，lerna等</li> <li>运行时微前端，是一次加载或通过延迟加载按需动态将微型前端注入到容器应用程序中时。当引入新的微前端的时候，不需要构建，可以动态在代码中定义加载。我眼中的微前端更多是
指这种运行时加载的微前端，因为独立构建，部署和测试是我们对于“微”的定义</li></ul> <p>微前端并非只能在客户端来实现，类似于服务端渲染，同样可以通过服务端来实现，服务端微前端的支持工具有：Mosaic，PuzzleJs，Podium，Micromono等</p> <p>市面上实现微前端的框架，可供选择的有iframe、sigle-spa、web components、webpack5 module federation、无界方案、qiankun和microApp</p> <ol><li>single-spa太过于基础，对原有项目的改造过多，成本太高</li> <li>iframe在所有微前端方案中是最稳定的、上手难度最低的，但它有一些无法解决的问题，例如性能低、通信复杂、双滚动条、弹窗无法全局
覆盖，它的成长性不高，只适合简单的页面渲染</li> <li>web components 不推荐，无法提供模块化功能，项目越大，越容易失控，web component 本质是封装自定义的 html,想想jQuery的问题</li> <li>webpack5 module federation，webpack5全新思路，而且可以导出某个项目的某个组件，不能限制子项目的使用工具是基本原则，而且没有有效的 css 沙箱和 js 沙箱，
需要靠用户自觉,多应用激活无法实现</li> <li>当然还有微盟、头条等很多大厂均会有自己的框架，来完美切合自己项目的需求，没有真完美微前端方案，无论什么方案在复杂的浏览器加载环境，运行环境下终会出错</li> <li>无界方案个人比较看好的方案，但是生态不够</li></ol> <p>剩下的市面上就只有两种，就看自己选择了qiankun和microApp，我选择的理由，只可以讲符合我个人想法
<img src="/webLearningRecord/assets/img/4.b44e9bc2.png" alt="An image"> <a href="https://micro-zoe.github.io/micro-app/docs.html#/" target="_blank" rel="noopener noreferrer">microApp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://qiankun.umijs.org/zh/guide" target="_blank" rel="noopener noreferrer">qiankun<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>上面是网上给的图可以知道他们大概的不同，就说几点通信机制props和发布订阅各有利弊不该作为分割标准，接入其实都很简单，至于静态资源的路径自动补全，怎么说呢不太需要，大多情况我们
都是都过publicpath的配置来解决，qiankun还能支持ie给他打polyfill即可</p> <p>关注的点：</p> <ol><li>子应用未来的应用不断扩大的话，子应用并存同一个页面，子应用需要互相嵌套;</li> <li>子项目就应该是个组件哪里都能用，这符合前端的思维，只是这个组件是我们自定义的customelement,这符合xml，也是万维网支持的</li> <li>当某些模块如果需要保存其状态，频繁的加载卸载真的合理么，是否能像vue一样keep alive</li> <li>完全的js沙箱隔离是合理的么？子项目对所全局对象都得隔离了，如果说主项目加载了个三方埋点插件什么的，他全局挂载了个变量方法，子项目得使用该变量方法来发送埋点，隔离之后就无法反问，是否可以加些
配置让子项目可以反问呢，控制开发给子项目哪些变量，哪些变量可以逃逸到外部window上不是更松散更香，但是这是双刃剑，不可随意使用,单有奇效</li> <li>自定义的fetch,我们知道无论是哪种框架最终都要fetch子项目的资源，我们主项目是否可以对这些资源做些劫持过滤呢，假设我有一些子应用加载了elementui,我现在想升级，难度我就只能一个个改么，我完全
可以劫持加载的静态资源方式，把他打到我想让他加载的资源上,甚至还可以根据需要未每个拉取的资源带上cookie</li> <li>元素隔离的概念来自ShadowDom，即ShadowDom中的元素可以和外部的元素重复但不会冲突，micro-app模拟实现了类似ShadowDom的功能，元素不会逃离<code>&lt;micro-app&gt;</code>元素边界，子应用只能对自身的元素
进行增、删、改、查的操作</li></ol> <p>我们不知道主应用有哪些dom，也不知道多个自已用有哪些dom,如果直接操作某个dom消失，假设其他应用也有改dom，则会导致错误</p> <p>简单来说基座应用和子应用都有一个元素<code>&lt;div id='root'&gt;&lt;/div&gt;</code>，此时子应用通过document.querySelector('#root')获取到的是自己内部的#root元素，而不是基座应用的</p> <h4 id="综上对与我们的项目，任意子项目可能组合，静态资源不规范每个人都会根据情况胡乱升级改版本例如elementui-技术上想保持多元化，接入上想尽量简单不用装什么包等，还是玩玩mircoapp吧"><a href="#综上对与我们的项目，任意子项目可能组合，静态资源不规范每个人都会根据情况胡乱升级改版本例如elementui-技术上想保持多元化，接入上想尽量简单不用装什么包等，还是玩玩mircoapp吧" class="header-anchor">#</a> 综上对与我们的项目，任意子项目可能组合，静态资源不规范每个人都会根据情况胡乱升级改版本例如elementui,技术上想保持多元化，接入上想尽量简单不用装什么包等，还是玩玩mircoapp吧</h4> <p>同样的他所面临的问题也不少，例如css 沙箱依然无法绝对的隔离，js 沙箱做全局变量查找缓存，性能有所优化；虽然支持 vite 运行，但必须使用 plugin 改
造子应用，且 js 代码没办法做沙箱隔离；对于不支持 webcompnent 的浏览器没有做降级处理等等</p> <h4 id="无界方案"><a href="#无界方案" class="header-anchor">#</a> 无界方案</h4> <p>无界微前端方案基于 webcomponent 容器 + iframe 沙箱，能够完善的解决适配成本、样式隔离、运行性能、页面白屏、子应用通信、子应用保活、多应用激活、vite 框架支持、应用共享等用户的核心诉求</p> <ol><li>无界微前端非常快，主要体现在首屏·打开快、运行速度快两个方面</li> <li>目前大部分微前端只能做到静态资源预加载，但是就算子应用所有资源都预加载完毕，等到子应用打开时页面仍然有不短的白屏时间，这部分白屏时间主要是子应用 js 的解析和执行</li> <li>无界微前端不仅能够做到静态资源的预加载，还可以做到子应用的预执行</li> <li>预执行会阻塞主应用的执行线程，所以无界提供 fiber 执行模式，采取类似 react fiber 的方式间断执行 js，每个 js 文件的执行都包裹在 requestidlecallback 中，每执行一个 js 可以返回响
应外部的输入，但是这个颗粒度是 js 文件，如果子应用单个 js 文件过大，可以通过拆包的方式降低体积达到 fiber 执行模式效益最大化</li> <li>子应用的 js 在 iframe 内运行，由于 iframe 是一个天然的 js 运行沙箱，所以无需采用 with ( fakewindow ) 这种方式来指定子应用的执行上下文，从而避免由于采用 with 语句执行子应用代码
而导致的性能下降，整体的运行性能和原生性能差别不大</li> <li>无界微前端实现了 css 沙箱和 js 沙箱的原生隔离，子应用不用担心污染问题</li> <li>无界子应用运行在 iframe 中原生支持 esm 的脚本，而且不用担心子应用运行的上下文问题，因为子应用读取的就是 iframe 的 window 上下文，所以无界微前端原生支持 vite 框架
不做过多介绍了，大家直接看文档<a href="https://wujie-micro.github.io/doc/guide/" target="_blank" rel="noopener noreferrer">wujie<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <h2 id="渲染篇"><a href="#渲染篇" class="header-anchor">#</a> 渲染篇</h2> <p>和micro-app一样，我们的简易微前端框架设计思路是像使用iframe一样简单，而又可以避免iframe存在的问题，其使用方式如下：
<img src="/webLearningRecord/assets/img/5.3e9a7ffd.png" alt="An image">
最终效果也有点类似，整个微前端应用都被封装在自定义标签micro-app中，渲染后效果如下图：
<img src="/webLearningRecord/assets/img/6.96875788.png" alt="An image">
所以我们整体架构思路为：CustomElement + HTMLEntry, HTMLEntry就是以html文件作为入口地址进行渲染，入上图
中的http://localhost:3000/就是一个html地址
<img src="/webLearningRecord/assets/img/7.e33c9d14.png" alt="An image"></p> <h3 id="前置工作"><a href="#前置工作" class="header-anchor">#</a> 前置工作</h3> <p>在正式开始之前，我们需要搭建一个开发环境，创建一个代码仓库simple-micro-app,代码结构如下
<img src="/webLearningRecord/assets/img/8.ab397eb4.png" alt="An image">
代码仓库主要分为src主目录和examples案例目录，vue2为基座应用，react17为子应用，两个项目都是使用官方脚手架创建的，构建工具使用rollup</p> <p>在vue2项目中，配置resolve.alias，将simple-micro-app指向src目录的index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue.config.js</span>
<span class="token operator">...</span>
<span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>alias
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;simple-micro-app&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../src/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>在react17的webpack-dev-server中配置静态资源支持跨域访问</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/webpackDevServer.config.js</span>
<span class="token operator">...</span>
headers<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="创建容器"><a href="#创建容器" class="header-anchor">#</a> 创建容器</h3> <p>微前端的渲染是将子应用的js、css等静态资源加载到基座应用中执行，所以基座应用和子应用本质是同一个页面。这不同于iframe，iframe则是创建一个新
的窗口，由于每次加载都要初始化整个窗口信息，所以iframe的性能不高</p> <p>如同每个前端框架在渲染时都要指定一个根元素，微前端渲染时也需要指定一个根元素作为容器，这个根元素可以是一个div或其它元素</p> <p>这里我们使用的是通过customElements创建的自定义元素，因为它不仅提供一个元素容器，还自带了生命周期函数，我们可以在这些钩子函数中进行加载
渲染等操作，从而简化步骤</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/element.js</span>

<span class="token comment">// 自定义元素</span>
<span class="token keyword">class</span> <span class="token class-name">MyElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
  <span class="token comment">// 声明需要监听的属性名，只有这些属性变化时才会触发attributeChangedCallback</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">observedAttributes</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'url'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 元素被插入到DOM时执行，此时去加载子应用的静态资源并渲染</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'micro-app is connected'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">disconnectedCallback</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 元素从DOM中删除时执行，此时进行一些卸载操作</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'micro-app has disconnected'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">attributeChangedCallback</span> <span class="token punctuation">(</span><span class="token parameter">attr<span class="token punctuation">,</span> oldVal<span class="token punctuation">,</span> newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 元素属性发生变化时执行，可以获取name、url等属性的值</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">attribute </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>attrName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newVal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 注册元素
 * 注册后，就可以像普通元素一样使用micro-app，当micro-app元素被插入或删除DOM时即可触发相应的生命周期函数。
 */</span>
window<span class="token punctuation">.</span>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'micro-app'</span><span class="token punctuation">,</span> MyElement<span class="token punctuation">)</span>
</code></pre></div><p>micro-app元素可能存在重复定义的情况，所以我们加一层判断，并放入函数中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/element.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineElement</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果已经定义过，则忽略</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>customElements<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'micro-app'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'micro-app'</span><span class="token punctuation">,</span> MyElement<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在/src/index.js中定义默认对象SimpleMicroApp，引入并执行defineElement函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./element'</span>
<span class="token keyword">const</span> SimpleMicroApp <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">start</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">defineElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> SimpleMicroApp
</code></pre></div><p>在vue2项目的main.js中引入simple-micro-app，执行start函数进行初始化</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue2/src/main.js</span>
<span class="token keyword">import</span> SimpleMicroApp <span class="token keyword">from</span> <span class="token string">'simple-micro-app'</span>
SimpleMicroApp<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 然后就可以在vue2项目中的任何位置使用micro-app标签</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>micro<span class="token operator">-</span>app name<span class="token operator">=</span><span class="token string">'app'</span> url<span class="token operator">=</span><span class="token string">'http://localhost:3001/'</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>micro<span class="token operator">-</span>app<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre></div><p>插入micro-app标签后，就可以看到控制台打印的钩子信息
<img src="/webLearningRecord/assets/img/9.4d905542.png" alt="An image">
以上我们就完成了容器元素的初始化，子应用的所有元素都会放入到这个容器中。接下来我们就需要完成子应用的静态资源加载及渲染</p> <h3 id="创建微应用实例"><a href="#创建微应用实例" class="header-anchor">#</a> 创建微应用实例</h3> <p>很显然，初始化的操作要放在connectedCallback 中执行。我们声明一个类，它的每一个实例都对应一个微应用，用于控制微应用的资源加载、渲染、卸载等</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/app.js</span>

<span class="token comment">// 创建微应用</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">CreateApp</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在初始化实例时，根据传入的参数请求静态资源</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> url<span class="token punctuation">,</span> container <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token comment">// 应用名称</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url  <span class="token comment">// url地址</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> container <span class="token comment">// micro-app元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'loading'</span>
    <span class="token function">loadHtml</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  status <span class="token operator">=</span> <span class="token string">'created'</span> <span class="token comment">// 组件状态，包括 created/loading/mount/unmount</span>

  <span class="token comment">// 存放应用的静态资源</span>
  source <span class="token operator">=</span> <span class="token punctuation">{</span> 
    links<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// link元素对应的静态资源</span>
    scripts<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// script元素对应的静态资源</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 资源加载完时执行</span>
  <span class="token function">onLoad</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">/**
   * 资源加载完成后进行渲染
   */</span>
  <span class="token function">mount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">/**
   * 卸载应用
   * 执行关闭沙箱，清空缓存等操作
   */</span>
  <span class="token function">unmount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们在connectedCallback函数中初始化实例，将name、url及元素自身作为参数传入，在CreateApp的constructor中记录这些值，并根据url地址请求html</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/element.js</span>
<span class="token keyword">import</span> CreateApp<span class="token punctuation">,</span> <span class="token punctuation">{</span> appInstanceMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>
<span class="token operator">...</span>
<span class="token function">connectedCallback</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建微应用实例,内部会下载html使用的是loadHtml</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    url<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span>
    container<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 记入缓存，用于后续功能</span>
  appInstanceMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">attributeChangedCallback</span> <span class="token punctuation">(</span><span class="token parameter">attrName<span class="token punctuation">,</span> oldVal<span class="token punctuation">,</span> newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 分别记录name及url的值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>attrName <span class="token operator">===</span> <span class="token string">'name'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> newVal
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attrName <span class="token operator">===</span> <span class="token string">'url'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">&amp;&amp;</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> newVal
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>需要对获取的html做处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/source.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetchSource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadHtml</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fetchSource</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    html <span class="token operator">=</span> html
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;head[^&gt;]*&gt;[\s\S]*?&lt;\/head&gt;/i</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将head标签替换为micro-app-head，因为web页面只允许有一个head标签</span>
        <span class="token keyword">return</span> match
          <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;head/i</span><span class="token punctuation">,</span> <span class="token string">'&lt;micro-app-head'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;\/head&gt;/i</span><span class="token punctuation">,</span> <span class="token string">'&lt;/micro-app-head&gt;'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;body[^&gt;]*&gt;[\s\S]*?&lt;\/body&gt;/i</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将body标签替换为micro-app-body，防止与基座应用的body标签重复导致的问题。</span>
        <span class="token keyword">return</span> match
          <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;body/i</span><span class="token punctuation">,</span> <span class="token string">'&lt;micro-app-body'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;\/body&gt;/i</span><span class="token punctuation">,</span> <span class="token string">'&lt;/micro-app-body&gt;'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 将html字符串转化为DOM结构</span>
    <span class="token keyword">const</span> htmlDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
    htmlDom<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'html:'</span><span class="token punctuation">,</span> htmlDom<span class="token punctuation">)</span>

    <span class="token comment">// 进一步提取和处理js、css等静态资源</span>
    <span class="token function">extractSourceDom</span><span class="token punctuation">(</span>htmlDom<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'加载html出错'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>html格式化后，我们就可以得到一个DOM结构。从下图可以看到，这个DOM结构包含link、style、script等标签，接下来就需要对这个DOM做进一步处理
<img src="/webLearningRecord/assets/img/10.b084dfa5.png" alt="An image"></p> <h3 id="提取js、css等静态资源地址"><a href="#提取js、css等静态资源地址" class="header-anchor">#</a> 提取js、css等静态资源地址</h3> <p>我们在extractSourceDom方法中循环递归处理每一个DOM节点，查询到所有link、style、script标签，提取静态资源地址并格式化标签</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/source.js</span>

<span class="token comment">/**
 * 递归处理每一个子元素
 * @param parent 父元素
 * @param app 应用实例
 */</span>
<span class="token keyword">function</span> <span class="token function">extractSourceDom</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
  
  <span class="token comment">// 递归每一个子元素</span>
  children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">extractSourceDom</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dom <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dom <span class="token keyword">instanceof</span> <span class="token class-name">HTMLLinkElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 提取css地址</span>
      <span class="token keyword">const</span> href <span class="token operator">=</span> dom<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'rel'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'stylesheet'</span> <span class="token operator">&amp;&amp;</span> href<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 计入source缓存中</span>
        app<span class="token punctuation">.</span>source<span class="token punctuation">.</span>links<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>href<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          code<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 代码内容</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 删除原有元素</span>
      parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dom <span class="token keyword">instanceof</span> <span class="token class-name">HTMLScriptElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 并提取js地址</span>
      <span class="token keyword">const</span> src <span class="token operator">=</span> dom<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 远程script</span>
        app<span class="token punctuation">.</span>source<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          code<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 代码内容</span>
          isExternal<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否远程script</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 内联script</span>
        <span class="token keyword">const</span> nonceStr <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span>
        app<span class="token punctuation">.</span>source<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nonceStr<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          code<span class="token operator">:</span> dom<span class="token punctuation">.</span>textContent<span class="token punctuation">,</span> <span class="token comment">// 代码内容</span>
          isExternal<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 是否远程script</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dom <span class="token keyword">instanceof</span> <span class="token class-name">HTMLStyleElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 进行样式隔离</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="请求静态资源"><a href="#请求静态资源" class="header-anchor">#</a> 请求静态资源</h3> <p>上面已经拿到了html中的css、js等静态资源的地址，接下来就是请求这些地址，拿到资源的内容。接着完善loadHtml，在extractSourceDom下面
添加请求资源的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/source.js</span>
<span class="token operator">...</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadHtml</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 进一步提取和处理js、css等静态资源</span>
  <span class="token function">extractSourceDom</span><span class="token punctuation">(</span>htmlDom<span class="token punctuation">,</span> app<span class="token punctuation">)</span>

  <span class="token comment">// 获取micro-app-head元素</span>
  <span class="token keyword">const</span> microAppHead <span class="token operator">=</span> htmlDom<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'micro-app-head'</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果有远程css资源，则通过fetch请求</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>source<span class="token punctuation">.</span>links<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fetchLinksFromHtml</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> microAppHead<span class="token punctuation">,</span> htmlDom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span>htmlDom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果有远程js资源，则通过fetch请求</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>source<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fetchScriptsFromHtml</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> htmlDom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span>htmlDom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>fetchLinksFromHtml和fetchScriptsFromHtml分别请求css和js资源，请求资源后的处理方式不同，css资源会转化为style标签插入DOM中，而js不会立即执
行，我们会在应用的mount方法中执行js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/source.js</span>
<span class="token comment">/**
 * 获取link远程资源
 * @param app 应用实例
 * @param microAppHead micro-app-head
 * @param htmlDom html DOM结构
 */</span>
 <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fetchLinksFromHtml</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> microAppHead<span class="token punctuation">,</span> htmlDom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> linkEntries <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>source<span class="token punctuation">.</span>links<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 通过fetch请求所有css资源</span>
  <span class="token keyword">const</span> fetchLinkPromise <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token keyword">of</span> linkEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fetchLinkPromise<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>fetchLinkPromise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> res<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token comment">// 拿到css资源后放入style元素并插入到micro-app-head中</span>
      <span class="token keyword">const</span> link2Style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span>
      link2Style<span class="token punctuation">.</span>textContent <span class="token operator">=</span> code
      microAppHead<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>link2Style<span class="token punctuation">)</span>

      <span class="token comment">// 将代码放入缓存，再次渲染时可以从缓存中获取</span>
      linkEntries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理完成后执行onLoad方法</span>
    app<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span>htmlDom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'加载css出错'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取js远程资源
 * @param app 应用实例
 * @param htmlDom html DOM结构
 */</span>
 <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fetchScriptsFromHtml</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> htmlDom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> scriptEntries <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>source<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 通过fetch请求所有js资源</span>
  <span class="token keyword">const</span> fetchScriptPromise <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>url<span class="token punctuation">,</span> info<span class="token punctuation">]</span> <span class="token keyword">of</span> scriptEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是内联script，则不需要请求资源</span>
    fetchScriptPromise<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>code <span class="token operator">?</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token operator">:</span>  <span class="token function">fetchSource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>fetchScriptPromise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> res<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token comment">// 将代码放入缓存，再次渲染时可以从缓存中获取</span>
      scriptEntries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理完成后执行onLoad方法</span>
    app<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span>htmlDom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'加载js出错'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面可以看到，css和js加载完成后都执行了onLoad方法，所以onLoad方法被执行了两次，接下来我们就要完善onLoad方法并渲染微应用</p> <h3 id="渲染"><a href="#渲染" class="header-anchor">#</a> 渲染</h3> <p>因为onLoad被执行了两次，所以我们进行标记，当第二次执行时说明所有资源都加载完成，然后进行渲染操作</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/app.js</span>

<span class="token comment">// 创建微应用</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">CreateApp</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 资源加载完时执行</span>
  <span class="token function">onLoad</span> <span class="token punctuation">(</span><span class="token parameter">htmlDom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loadCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadCount <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadCount <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token comment">// 第二次执行且组件未卸载时执行渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>loadCount <span class="token operator">===</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">'unmount'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 记录DOM结构用于后续操作</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span>html <span class="token operator">=</span> htmlDom
      <span class="token comment">// 执行mount方法</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在mount方法中将DOM结构插入文档中，然后执行js文件进行渲染操作，此时微应用即可完成基本的渲染</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/app.js</span>

<span class="token comment">// 创建微应用</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">CreateApp</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">/**
   * 资源加载完成后进行渲染
   */</span>
  <span class="token function">mount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 克隆DOM节点</span>
    <span class="token keyword">const</span> cloneHtml <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span>html<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// 创建一个fragment节点作为模版，这样不会产生冗余的元素</span>
    <span class="token keyword">const</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>cloneHtml<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 将格式化后的DOM结构插入到容器中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>

    <span class="token comment">// 执行js</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> eval<span class="token punctuation">)</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 标记应用为已渲染</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'mounted'</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="卸载"><a href="#卸载" class="header-anchor">#</a> 卸载</h3> <p>当micro-app元素被删除时会自动执行生命周期函数disconnectedCallback，我们在此处执行卸载相关操作</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/element.js</span>

<span class="token keyword">class</span> <span class="token class-name">MyElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token function">disconnectedCallback</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取应用实例</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> appInstanceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token comment">// 如果有属性destory，则完全卸载应用包括缓存的文件</span>
    app<span class="token punctuation">.</span><span class="token function">unmount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'destory'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来完善应用的unmount方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/app.js</span>
<span class="token comment">// 当destory为true时，删除应用的实例，此时所有静态资源失去了引用，自动被浏览器回收</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">CreateApp</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">/**
   * 卸载应用
   * @param destory 是否完全销毁，删除缓存资源
   */</span>
  <span class="token function">unmount</span> <span class="token punctuation">(</span><span class="token parameter">destory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'unmount'</span>
    <span class="token comment">// 清空容器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// destory为true，则删除应用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>destory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      appInstanceMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="沙箱篇"><a href="#沙箱篇" class="header-anchor">#</a> 沙箱篇</h2> <p>我们列出了两个具体的问题，然后通过创建沙箱来解决</p> <ol><li>子应用向window上添加一个全局变量：globalStr='child'，如果此时基座应用也有一个相同的全局变量：globalStr='parent'，此时就产生了变量冲突，基座应用的变量会被覆盖</li> <li>子应用渲染后通过监听scroll添加了一个全局监听事件</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>当子应用被卸载时，监听函数却没有解除绑定，对页面滚动的监听一直存在。如果子应用二次渲染，监听函数会绑定两次，这显然是错误的, 接下来我们就通过给微前端创建一个JS沙箱环
境，隔离基座应用和子应用的JS，从而解决这两个典型的问题</p> <h3 id="创建沙箱"><a href="#创建沙箱" class="header-anchor">#</a> 创建沙箱</h3> <p>由于每个子应用都需要一个独立的沙箱，所以我们通过class创建一个类：SandBox，当一个新的子应用被创建时，就创建一个新的沙箱与其绑定</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/sandbox.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  active <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 沙箱是否在运行</span>
  microWindow <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// // 代理的对象</span>
  injectedKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 新添加的属性，在卸载时清空</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 启动</span>
  <span class="token function">start</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 停止</span>
  <span class="token function">stop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们使用Proxy进行代理操作，代理对象为空对象microWindow，得益于Proxy强大的功能，实现沙箱变得简单且高效。</p> <p>在constructor中进行代理相关操作，通过Proxy代理microWindow，设置get、set、deleteProperty三个拦截器，此时子应用对window的操作基本上可以覆盖</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/sandbox.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  active <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 沙箱是否在运行</span>
  microWindow <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// // 代理的对象</span>
  injectedKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 新添加的属性，在卸载时清空</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxyWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>microWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 取值</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 优先从代理对象上取值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 否则兜底到window对象上取值</span>
        <span class="token keyword">const</span> rawValue <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> key<span class="token punctuation">)</span>

        <span class="token comment">// 如果兜底的值为函数，则需要绑定window对象，如：console、alert等</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> rawValue <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> valueStr <span class="token operator">=</span> rawValue<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// 排除构造函数</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^function\s+[A-Z]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>valueStr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token regex">/^class\s+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>valueStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">rawValue</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 其它情况直接返回</span>
        <span class="token keyword">return</span> rawValue
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 设置变量</span>
      <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 沙箱只有在运行时可以设置变量</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

          <span class="token comment">// 记录添加的变量，用于后续清空操作</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>injectedKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">deleteProperty</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前key存在于代理对象上时才满足删除条件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建完代理后，我们接着完善start和stop两个方法，实现方式也非常简单，具体如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/sandbox.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 启动</span>
  <span class="token function">start</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 停止</span>
  <span class="token function">stop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token comment">// 清空变量</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>injectedKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>microWindow<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>injectedKeys<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="使用沙箱"><a href="#使用沙箱" class="header-anchor">#</a> 使用沙箱</h3> <p>在src/app.js中引入沙箱，在CreateApp的构造函数中创建沙箱实例，并在mount方法中执行沙箱的start方法，在unmount方法中执行沙箱的stop方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/app.js</span>
<span class="token keyword">import</span> loadHtml <span class="token keyword">from</span> <span class="token string">'./source'</span>
<span class="token operator">+</span> <span class="token keyword">import</span> Sandbox <span class="token keyword">from</span> <span class="token string">'./sandbox'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">CreateApp</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> url<span class="token punctuation">,</span> container <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>sandbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sandbox</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>
  <span class="token function">mount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>sandbox<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 执行js</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> eval<span class="token punctuation">)</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 卸载应用
   * @param destory 是否完全销毁，删除缓存资源
   */</span>
  <span class="token function">unmount</span> <span class="token punctuation">(</span><span class="token parameter">destory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>sandbox<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// destory为true，则删除应用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>destory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      appInstanceMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们还需要将子应用的js通过一个with函数包裹，修改js作用域，将子应用的window指向代理的对象。形式如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">window<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">with</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    子应用的js代码
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>代理对象<span class="token punctuation">,</span> 代理对象<span class="token punctuation">,</span> 代理对象<span class="token punctuation">)</span>
</code></pre></div><p>在sandbox中添加方法bindScope，修改js作用域：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/sandbox.js</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 修改js作用域</span>
  <span class="token function">bindScope</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>proxyWindow <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>proxyWindow
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">;(function(window, self){with(window){;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n}}).call(window.proxyWindow, window.proxyWindow, window.proxyWindow);</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后在mount方法中添加对bindScope的使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/app.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">CreateApp</span> <span class="token punctuation">{</span>
  <span class="token function">mount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// 执行js</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> eval<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sandbox<span class="token punctuation">.</span><span class="token function">bindScope</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="重写全局事件"><a href="#重写全局事件" class="header-anchor">#</a> 重写全局事件</h3> <p>再来回顾一下第二个问题，错误的原因是在子应用卸载时没有清空事件监听，如果子应用知道自己将要被卸载，主动清空事件监听，这个问题可以避免，但这是理想情况，一是子应用
不知道自己何时被卸载，二是很多第三方库也有一些全局的监听事件，子应用无法全部控制。所以我们需要在子应用卸载时，自动将子应用残余的全局监听事件进行清空</p> <p>我们在沙箱中重写window.addEventListener和window.removeEventListener，记录所有全局监听事件，在应用卸载时如果有残余的全局监听事件则进行清空</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/sandbox.js</span>

<span class="token comment">// 记录addEventListener、removeEventListener原生方法</span>
<span class="token keyword">const</span> rawWindowAddEventListener <span class="token operator">=</span> window<span class="token punctuation">.</span>addEventListener
<span class="token keyword">const</span> rawWindowRemoveEventListener <span class="token operator">=</span> window<span class="token punctuation">.</span>removeEventListener

<span class="token comment">/**
 * 重写全局事件的监听和解绑
 * @param microWindow 原型对象
 */</span>
 <span class="token keyword">function</span> <span class="token function">effect</span> <span class="token punctuation">(</span><span class="token parameter">microWindow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用Map记录全局事件</span>
  <span class="token keyword">const</span> eventListenerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 重写addEventListener</span>
  microWindow<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> listenerList <span class="token operator">=</span> eventListenerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token comment">// 当前事件非第一次监听，则添加缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      listenerList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前事件第一次监听，则初始化数据</span>
      eventListenerMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>listener<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行原生监听函数</span>
    <span class="token keyword">return</span> <span class="token function">rawWindowAddEventListener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> type<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 重写removeEventListener</span>
  microWindow<span class="token punctuation">.</span><span class="token function-variable function">removeEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> listenerList <span class="token operator">=</span> eventListenerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token comment">// 从缓存中删除监听函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerList<span class="token operator">?.</span>size <span class="token operator">&amp;&amp;</span> listenerList<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      listenerList<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行原生解绑函数</span>
    <span class="token keyword">return</span> <span class="token function">rawWindowRemoveEventListener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> type<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 清空残余事件</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'需要卸载的全局事件'</span><span class="token punctuation">,</span> eventListenerMap<span class="token punctuation">)</span>
    <span class="token comment">// 清空window绑定事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventListenerMap<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将残余的没有解绑的函数依次解绑</span>
      eventListenerMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">listenerList<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerList<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> listener <span class="token keyword">of</span> listenerList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">rawWindowRemoveEventListener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> type<span class="token punctuation">,</span> listener<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      eventListenerMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在沙箱的构造函数中执行effect方法，得到卸载的钩子函数releaseEffect，在沙箱关闭时执行卸载操作，也就是在stop方法中执行releaseEffect函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/sandbox.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 修改js作用域</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 卸载钩子</span>
<span class="token operator">+</span>   <span class="token keyword">this</span><span class="token punctuation">.</span>releaseEffect <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>microWindow<span class="token punctuation">)</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token function">stop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token comment">// 清空变量</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>injectedKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>microWindow<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>injectedKeys<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      
      <span class="token comment">// 卸载全局事件</span>
<span class="token operator">+</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">releaseEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="样式隔离篇"><a href="#样式隔离篇" class="header-anchor">#</a> 样式隔离篇</h2> <p>要实现样式隔离必须对应用的css进行改造，因为基座应用无法控制，我们只能对子应用进行修改</p> <ol><li><p>子应用的所有元素都被插入到micro-app标签中，且micro-app标签具有唯一的name值，所以通过添加属性选择器前缀micro-app[name=xxx]可以让css样式在指定的micro-app内生效</p></li> <li><p>渲染篇中我们将link标签引入的远程css文件转换为style标签，所以子应用只会存在style标签，实现样式隔离的方式就是在style标签的每一个CSS规则前面加上
micro-app[name=xxx]的前缀，让所有CSS规则都只能影响到指定元素内部</p></li> <li><p>通过style.textContent获取样式内容是最简单的，但textContent拿到的是所有css内容的字符串，这样无法针对单独规则进行处理，所以我们要通过另外一种方式：CSSRules</p></li> <li><p>当style元素被插入到文档中时，浏览器会自动为style元素创建CSSStyleSheet样式表，一个 CSS 样式表包含了一组表示规则的 CSSRule 对象。每条 CSS 规则可以通过与之相关
联的对象进行操作，这些规则被包含在 CSSRuleList 内，可以通过样式表的 cssRules 属性获取
<img src="/webLearningRecord/assets/img/11.3622f02f.png" alt="An image">
所以cssRules就是由单个CSS规则组成的列表，我们只需要遍历规则列表，并在每个规则的选择器前加上前缀micro-app[name=xxx]，就可以将当前style样式的影响限制在micro-app元素内部</p></li></ol> <p>我们上面提到过，style元素插入到文档后会创建css样式表，但有些style元素(比如动态创建的style)在执行样式隔离时还没插入到文档中，此时样式表还没生成。所以我们需要创建一个模版
style元素，它用于处理这种特殊情况，模版style只作为格式化工具，不会对页面产生影响</p> <p>还有一种情况需要特殊处理：style元素被插入到文档中后再添加样式内容。这种情况常见于开发环境，通过style-loader插件创建的style元素。对于这种情况可以通过MutationObserver监
听style元素的变化，当style插入新的样式时再进行隔离处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/scopedcss.js</span>

<span class="token keyword">let</span> templateStyle <span class="token comment">// 模版sytle</span>

<span class="token comment">/**
 * 进行样式隔离
 * @param {HTMLStyleElement} styleElement style元素
 * @param {string} appName 应用名称
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">scopedCSS</span> <span class="token punctuation">(</span><span class="token parameter">styleElement<span class="token punctuation">,</span> appName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 前缀</span>
  <span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">micro-app[name=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span>

  <span class="token comment">// 初始化时创建模版标签</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>templateStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    templateStyle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>templateStyle<span class="token punctuation">)</span>
    <span class="token comment">// 设置样式表无效，防止对应用造成影响</span>
    templateStyle<span class="token punctuation">.</span>sheet<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>styleElement<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将元素的内容赋值给模版元素</span>
    templateStyle<span class="token punctuation">.</span>textContent <span class="token operator">=</span> styleElement<span class="token punctuation">.</span>textContent
    <span class="token comment">// 格式化规则，并将格式化后的规则赋值给style元素</span>
    styleElement<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">scopedRule</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>templateStyle<span class="token punctuation">.</span>sheet<span class="token operator">?.</span>cssRules <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
    <span class="token comment">// 清空模版style内容</span>
    templateStyle<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听动态添加内容的style元素</span>
    <span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 断开监听</span>
      observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 格式化规则，并将格式化后的规则赋值给style元素</span>
      styleElement<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">scopedRule</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>styleElement<span class="token punctuation">.</span>sheet<span class="token operator">?.</span>cssRules <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 监听style元素的内容是否变化</span>
    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>styleElement<span class="token punctuation">,</span> <span class="token punctuation">{</span> childList<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>scopedRule方法主要进行CSSRule.type的判断和处理，CSSRule.type类型有数十种，我们只处理STYLE_RULE、MEDIA_RULE、SUPPORTS_RULE三种
类型，它们分别对应的type值为：1、4、12，其它类型type不做处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/scopedcss.js</span>

<span class="token comment">/**
 * 依次处理每个cssRule
 * @param rules cssRule
 * @param prefix 前缀
 */</span>
 <span class="token keyword">function</span> <span class="token function">scopedRule</span> <span class="token punctuation">(</span><span class="token parameter">rules<span class="token punctuation">,</span> prefix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token comment">// 遍历rules，处理每一条规则</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> rule <span class="token keyword">of</span> rules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token comment">// STYLE_RULE</span>
        result <span class="token operator">+=</span> <span class="token function">scopedStyleRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> <span class="token comment">// MEDIA_RULE</span>
        result <span class="token operator">+=</span> <span class="token function">scopedPackRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> <span class="token string">'media'</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token number">12</span><span class="token operator">:</span> <span class="token comment">// SUPPORTS_RULE</span>
        result <span class="token operator">+=</span> <span class="token function">scopedPackRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> <span class="token string">'supports'</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        result <span class="token operator">+=</span> rule<span class="token punctuation">.</span>cssText
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>在scopedPackRule方法种对media和supports两种类型做进一步处理，因为它们包含子规则，我们需要递归处理它们的子规则。如：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">.test</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span>lightblue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 需变成这样 */</span>
<span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">micro-app[name=xxx] .test</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span>lightblue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>处理方式也十分简单：获取它们的子规则列表，递归执行方法scopedRule</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/scopedcss.js</span>

<span class="token comment">// 处理media 和 supports</span>
<span class="token keyword">function</span> <span class="token function">scopedPackRule</span> <span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> packName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 递归执行scopedRule，处理media 和 supports内部规则</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">scopedRule</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>cssRules<span class="token punctuation">)</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rule<span class="token punctuation">.</span>conditionText<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> {</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后实现scopedStyleRule方法，这里进行具体的CSS规则修改。修改规则的方式主要通过正则匹配，查询每个规则的选择器，在选择前加上前缀</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/scopedcss.js</span>

<span class="token comment">/**
 * 修改CSS规则，添加前缀
 * @param {CSSRule} rule css规则
 * @param {string} prefix 前缀
 */</span>
<span class="token keyword">function</span> <span class="token function">scopedStyleRule</span> <span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span> prefix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取CSS规则对象的选择和内容</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> selectorText<span class="token punctuation">,</span> cssText <span class="token punctuation">}</span> <span class="token operator">=</span> rule

  <span class="token comment">// 处理顶层选择器，如 body，html 都转换为 micro-app[name=xxx]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^((html[\s&gt;~,]+body)|(html|body|:root))$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>selectorText<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cssText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^((html[\s&gt;~,]+body)|(html|body|:root))/</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>selectorText <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 选择器 * 替换为 micro-app[name=xxx] *</span>
    <span class="token keyword">return</span> cssText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> *</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> builtInRootSelectorRE <span class="token operator">=</span> <span class="token regex">/(^|\s+)((html[\s&gt;~]+body)|(html|body|:root))(?=[\s&gt;~]+|$)/</span>

  <span class="token comment">// 匹配查询选择器</span>
  <span class="token keyword">return</span> cssText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^[\s\S]+{/</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">selectors</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> selectors<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/(^|,)([^,]+)/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">all<span class="token punctuation">,</span> $<span class="token number">1</span><span class="token punctuation">,</span> $<span class="token number">2</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果含有顶层选择器，需要单独处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>builtInRootSelectorRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>$<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// body[name=xx]|body.xx|body#xx 等都不需要转换</span>
        <span class="token keyword">return</span> all<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>builtInRootSelectorRE<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 在选择器前加上前缀</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">2.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^\s*/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在渲染篇中，我们有两处涉及到style元素的处理，一个是html字符串转换为DOM结构后的递归循环，一次是将link元素转换为style元素。所以我们需要在
这两个地方调用scopedCSS方法，并将style元素作为参数传入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/source.js</span>

<span class="token comment">/**
 * 递归处理每一个子元素
 * @param parent 父元素
 * @param app 应用实例
 */</span>
 <span class="token keyword">function</span> <span class="token function">extractSourceDom</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dom <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dom <span class="token keyword">instanceof</span> <span class="token class-name">HTMLLinkElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dom <span class="token keyword">instanceof</span> <span class="token class-name">HTMLStyleElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行样式隔离</span>
<span class="token operator">+</span>      <span class="token function">scopedCSS</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> app<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dom <span class="token keyword">instanceof</span> <span class="token class-name">HTMLScriptElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取link远程资源
 * @param app 应用实例
 * @param microAppHead micro-app-head
 * @param htmlDom html DOM结构
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fetchLinksFromHtml</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> microAppHead<span class="token punctuation">,</span> htmlDom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>fetchLinkPromise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> res<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token comment">// 拿到css资源后放入style元素并插入到micro-app-head中</span>
      <span class="token keyword">const</span> link2Style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span>
      link2Style<span class="token punctuation">.</span>textContent <span class="token operator">=</span> code
<span class="token operator">+</span>      <span class="token function">scopedCSS</span><span class="token punctuation">(</span>link2Style<span class="token punctuation">,</span> app<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'加载css出错'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="数据通信篇"><a href="#数据通信篇" class="header-anchor">#</a> 数据通信篇</h2> <p>微前端各个应用本身是独立运行的，通信系统不应该对应用侵入太深，所以我们采用发布订阅系统。但是由于子应用封装在micro-app标签内，作为一个类webComponents的
组件，发布订阅系统的弱绑定和它格格不入</p> <p>最好的方式是像普通属性一样通过micro-app元素传递数据。但自定义元素无法支持对象类型的属性，只能传递字符串，例如
<code>&lt;micro-app data={x: 1}&gt;&lt;/micro-app&gt; 会转换为 &lt;micro-app data='[object Object]'&gt;&lt;/micro-app&gt;</code>想要以组件化形式进行数据通信必须让元素支持对象
类型属性，为此我们需要重写micro-app原型链上setAttribute方法处理对象类型属性
<img src="/webLearningRecord/assets/img/12.6039c401.png" alt="An image"></p> <p>发布订阅系统有很多可以自己实现，也很很灵活，但太过于灵活可能会导致数据传输的混乱，必须定义一套清晰的数据流。所以我们要进行数据绑定，基座应用一次只能向指定
的子应用发送数据，子应用只能发送数据到基座应用，至于子应用之间的数据通信则通过基座应用进行控制，这样数据流就会变得清晰</p> <p>由于基座应用和子应用的数据通信方式不同，我们分开定义</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过格式化订阅名称来进行数据的绑定通信</span>
<span class="token comment">/**
 * 格式化事件名称，保证基座应用和子应用的绑定通信
 * @param appName 应用名称
 * @param fromBaseApp 是否从基座应用发送数据
 */</span>
 <span class="token keyword">function</span> <span class="token function">formatEventName</span> <span class="token punctuation">(</span><span class="token parameter">appName<span class="token punctuation">,</span> fromBaseApp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> appName <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token operator">!</span>appName<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span>
  <span class="token keyword">return</span> fromBaseApp <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__from_base_app_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">__</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__from_micro_app_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">__</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token comment">// /src/data.js</span>

<span class="token comment">// 基座应用的数据通信方法集合</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventCenterForBaseApp</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 向指定子应用发送数据
   * @param appName 子应用名称
   * @param data 对象数据
   */</span>
  <span class="token function">setData</span> <span class="token punctuation">(</span><span class="token parameter">appName<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventCenter<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">formatEventName</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 清空某个应用的监听函数
   * @param appName 子应用名称
   */</span>
  <span class="token function">clearDataListener</span> <span class="token punctuation">(</span><span class="token parameter">appName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventCenter<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token function">formatEventName</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 子应用的数据通信方法集合</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventCenterForMicroApp</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">appName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>appName <span class="token operator">=</span> appName
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 监听基座应用发送的数据
   * @param cb 绑定函数
   */</span>
  <span class="token function">addDataListener</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventCenter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token function">formatEventName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>appName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 解除监听函数
   * @param cb 绑定函数
   */</span>
  <span class="token function">removeDataListener</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> cb <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventCenter<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token function">formatEventName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>appName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 向基座应用发送数据
   * @param data 对象数据
   */</span>
  <span class="token function">dispatch</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> appInstanceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>appName<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token operator">?.</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 子应用以自定义事件的形式发送数据</span>
      <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span><span class="token string">'datachange'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        detail<span class="token operator">:</span> <span class="token punctuation">{</span>
          data<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      app<span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 清空当前子应用绑定的所有监听函数
   */</span>
  <span class="token function">clearDataListener</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventCenter<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token function">formatEventName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>appName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在入口文件中创建基座应用通信对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventCenterForBaseApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./data'</span>
<span class="token keyword">const</span> BaseAppData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventCenterForBaseApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>在沙箱中创建子应用的通信对象，并在沙箱关闭时清空所有绑定的事件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/sandbox.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> EventCenterForMicroApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./data'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">appName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建数据通信对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>microWindow<span class="token punctuation">.</span>microApp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventCenterForMicroApp</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token function">stop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// 清空所有绑定函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>microWindow<span class="token punctuation">.</span>microApp<span class="token punctuation">.</span><span class="token function">clearDataListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这里，数据通信大部分功能都完成了，但还缺少一点，就是对micro-app元素对象类型属性的支持。我们重写Element原型链上setAttribute方法，
当micro-app元素设置data属性时进行特殊处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/index.js</span>

<span class="token comment">// 记录原生方法</span>
<span class="token keyword">const</span> rawSetAttribute <span class="token operator">=</span> <span class="token class-name">Element</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setAttribute

<span class="token comment">// 重写setAttribute</span>
<span class="token class-name">Element</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setAttribute</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">setAttribute</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 目标为micro-app标签且属性名称为data时进行处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^micro-app/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tagName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">===</span> <span class="token string">'data'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Object]'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 克隆一个新的对象</span>
      <span class="token keyword">const</span> cloneValue <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">propertyKey</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 过滤vue框架注入的数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> propertyKey <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> propertyKey<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'__'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          cloneValue<span class="token punctuation">[</span>propertyKey<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>propertyKey<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 发送数据</span>
      BaseAppData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cloneValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">rawSetAttribute</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h2> <p>我们知道沙箱的核心思路是大概这样</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> windowProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> traps<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">with</span><span class="token punctuation">(</span>windowProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 应用代码，通过 with 确保所有的全局变量的操作实际都是在操作 qiankun 提供的代理对象</span>
  $<span class="token punctuation">{</span>appCode<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>主要的性能问题是，如果我们代码频繁访问沙箱，就会出现卡顿，思路也很简单,缓存下来减少沙箱的访问次数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> windowProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> traps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">with</span><span class="token punctuation">(</span>windowProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 提前将一些全局变量通过 赋值/取值 从 proxy 里缓存下来</span>
<span class="token comment">// 用const声明</span>
<span class="token keyword">var</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> windowProxy<span class="token punctuation">.</span>undefined<span class="token punctuation">;</span> <span class="token keyword">var</span> Array <span class="token operator">=</span> windowProxy<span class="token punctuation">.</span>Array<span class="token punctuation">;</span> <span class="token keyword">var</span> Promise <span class="token operator">=</span> windowProxy<span class="token punctuation">.</span>Promise<span class="token punctuation">;</span>
  <span class="token comment">// 应用代码，通过 with 确保所有的全局变量的操作实际都是在操作 qiankun 提供的代理对象</span>
  $<span class="token punctuation">{</span>appCode<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码没有生效，原因还是得说到var在with里面的作用，得把var改成const就可以了，简言之就是，在通过 var 初始化变量时，如果它是被套在 with 声明里的，则会先去检查当前 with 处
理过后的词法环境里是否有重名变量，如果有的话则直接将值写给同名属性，否则按正常流程，写到当前的词法环境（对应的 variable environment）里</p> <h4 id="es-拾遗之-with-声明与-var-变量赋值"><a href="#es-拾遗之-with-声明与-var-变量赋值" class="header-anchor">#</a> ES 拾遗之 with 声明与 var 变量赋值</h4> <p>umi 4 的应用作为子应用嵌入时，会触发 Maximum call stack size exceeded异常，初步排查的原因是 esbuild 导致的，解决方案是通过配置 jsMinifier: 'terser'替换掉默认
的 esbuild minifier 即可。但这个是解决方案，不是问题原因，换言之我们只是用了一个 workaround 绕过了问题。terser可以控制压缩的变量，不是所有变量都会变成简单字符</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> win <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token operator">:</span><span class="token number">456</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">with</span> <span class="token punctuation">(</span>win<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">456</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出结果</span>
<span class="token comment">// {a:456}</span>
<span class="token comment">// {a:123}</span>
<span class="token comment">// {a:123}</span>
</code></pre></div><p>with 是在一个 IIFE（用于独立的作用域）里触发的，变量 a （通过 var 声明）写到了 with 对应的变量空间 win 对象上,如果变量 a 的声明可以写到 win 对象上，为啥变量 b 没有写上去？</p> <p>因为对象 win 上已经存在属性 a，但是并不存在属性 b。从结果推测原因的话，可能得出一个初步结论：
<code>在 with 代码块里，对于 scope 里已有的属性声明+赋值，是会直接写到 scope 变量上的。而对于 scope 变量不存在的属性 + 赋值，则不会写到 scope 变量上</code></p> <p><img src="/webLearningRecord/assets/img/13.8e641c84.png" alt="An image"></p> <p>从表象上看，是因为 umi 4 的产物中有顶层作用域的 helpers：
<img src="/webLearningRecord/assets/img/14.ef3d870c.png" alt="An image">
上述产物在经 esbuild 压缩后，全局作用域的 helpers 变量有可能出现碰撞，比如父应用和子应用的 __hasOwnProp 都被压缩成 aB；那么子应用的代码在加载时，内部的 with statement +
variable declaration 会先从 window.proxy 上找 aB，失败后就会穿透沙箱尝试在顶层 window 去找，最终找到父应用的 aB 进行改写、读取。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
 * Stage 1: 父应用初始化
 */</span>
<span class="token comment">// window.aB 被赋值</span>
<span class="token keyword">var</span> aB <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">;</span>

<span class="token comment">/*
 * Stage 2: 子应用初始化
 */</span>
<span class="token keyword">with</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> aB <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 由于 with 的行为，上述代码等同于↓</span>
<span class="token keyword">var</span> aB <span class="token operator">=</span> window<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>aB <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">;</span>

<span class="token comment">/*
 * Stage 3: 沙箱穿透
 */</span>
<span class="token comment">// 在 proxy 上找不到 aB 的时候，自动穿透到顶层 window，上述代码进一步变化↓</span>
<span class="token keyword">var</span> aB <span class="token operator">=</span> window<span class="token punctuation">.</span>aB <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">;</span>

<span class="token comment">// 由于沙箱穿透后需要确保返回的对象能正常调用，所以需要 bind 顶层 window，上述代码最终成为↓</span>
<span class="token keyword">var</span> aB <span class="token operator">=</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>aB <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Stage 4: 子应用消费
 */</span>
<span class="token comment">// helpers 消费 aB 将永远获得错误的结果，因为 call 不再有效</span>
<span class="token function">aB</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>而运行时爆栈是因为 helpers 的执行始终不符预期，导致原本正常的框架逻辑进入死循环，至此问题逐渐清晰</p> <h4 id="terser"><a href="#terser" class="header-anchor">#</a> terser</h4> <p>webpack production模式下编译的文件，文件及变量名被修改、空格换行被去除，即使自己没有进行配置，webpack 也会在我们设置 production的模式时默认添加一些属性，比如这里js代码压缩用到的
就是 TerserPlugin; TerserPlugin处理代码依赖的是 terser这个工具， terser 是可以直接安装并独立使用的，使用的时候有非常多的配置可以自行定义，具体可参考</p> <p>通过 npm install terser-webpack-plugin --save-dev安装依赖后，在 webpack.config.js文件中定义对应的配置，更多配置可参考</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    minimize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        terserOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
          ecma<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
          parse<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          compress<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          mangle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          module<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          output<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          format<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          toplevel<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          nameCache<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          ie8<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          keep_classnames<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
          keep_fnames<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          safari10<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/webLearningRecord/web-consttruct/mySingleSpa.html" class="prev">
        自己实现一个微前端
      </a></span> <span class="next"><a href="/webLearningRecord/web-observe/web-observe.html">
        构建前端性能监控
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/webLearningRecord/assets/js/app.bdc4d5ac.js" defer></script><script src="/webLearningRecord/assets/js/2.1a231426.js" defer></script><script src="/webLearningRecord/assets/js/8.62631f20.js" defer></script>
  </body>
</html>
